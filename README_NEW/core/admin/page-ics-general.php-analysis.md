# File Analysis: `core/admin/page-ics-general.php`

This document provides a detailed analysis of the `core/admin/page-ics-general.php` file from the Booking Calendar plugin repository.

## High-Level Overview

This file creates the **"Sync Options"** settings page, which is located as a sub-tab under the main "Sync" tab in the plugin's settings. Its purpose is to provide a centralized place for administrators to configure global rules for how the plugin imports and exports events via `.ics` feeds, which are used by services like Google Calendar, Apple Calendar, and Outlook.

Architecturally, the file follows the plugin's standard and robust Settings API pattern. It defines one class (`WPBC_API_SettingsGeneralSync`) to specify the data and fields for the settings, and a second class (`WPBC_Page_SettingsGeneralSync`) to build the admin page UI and handle the data persistence.

A key feature of this page is the ability to dynamically map fields from any of the site's booking forms to specific properties of a calendar event, such as its title and location.

## Detailed Explanation

The file's logic is composed of two classes and two filter functions that work together.

-   **`WPBC_API_SettingsGeneralSync` class**: This class extends `WPBC_Settings_API` and is responsible for defining the actual settings fields.
    -   **`init_settings_fields()`**: This is the core method where all settings are defined.
        -   **Event Field Mapping**: It creates three dropdowns: "Event Title," "Event Description," and "Location." The options for these dropdowns are dynamically generated by the `wpbc_get__in_all_forms__field_names_arr()` function, which scans all booking forms and lists their fields. This allows an admin to map a booking form field (e.g., the `[text your-name]`) to an event property (e.g., the event's title).
        -   **Timezone**: It provides a comprehensive dropdown of world timezones, allowing an admin to force a specific timezone for sync operations to resolve date/time discrepancies.
        -   **Advanced Import/Export**: It defines several advanced options, such as appending a check-out day during import, using the plugin's check-in/out times, exporting only approved bookings, and a crucial setting to automatically trash or delete previously imported events before a new import to keep the calendar clean.

-   **`WPBC_Page_SettingsGeneralSync` class**: This class extends `WPBC_Page_Structure` and builds the admin page.
    -   **`tabs()`**: Defines the "Sync" top-level tab and the "Sync Options" sub-tab within the main settings page structure.
    -   **`content()`**: Renders the page's HTML. It uses `wpbc_open_meta_box_section()` to create collapsible sections for "General Settings," "Assign events fields," and "Advanced" import/export rules. Inside each section, it calls `$this->get_api()->show()` to render the actual form fields.

-   **Pseudo-Option Data Handling**: The file uses a clever pattern to manage the event field mapping.
    -   The UI displays three separate dropdowns, but these do not correspond to real options in the database.
    -   **`wpbc_fields_before_saving_to_db__general_sync()`**: This function hooks into a filter that runs before settings are saved. It takes the values from the three "pseudo" dropdowns, combines them into a single associative array, and saves this array to the *real* database option, `booking_gcal_events_form_fields`. It then removes the pseudo-fields from the array so they are not saved individually.
    -   **`wpbc_fields_after_saving_to_db__general_sync()`**: This function hooks into a filter that runs after saving. It reads the real `booking_gcal_events_form_fields` option, unserializes the array, and uses the values to correctly populate the three pseudo-dropdowns for the next page load.

## Features Enabled

### Admin Menu

-   This file adds the **"Sync Options"** sub-tab to the **Settings > Sync** page.
-   It creates the entire user interface for configuring global `.ics` import/export rules, including:
    -   Mapping booking form fields to calendar event properties.
    -   Setting a global timezone for synchronization.
    -   Defining advanced rules for how to handle imported and exported events.

### User-Facing

-   This file has no direct user-facing features. However, the settings configured here have a significant impact on the user experience:
    -   **Exported Events**: The field mapping determines what information a user sees when they add a booking to their personal calendar (e.g., Google Calendar).
    -   **Availability**: The import rules affect the availability shown on the front-end calendar, as imported events can block out dates.

## Extension Opportunities

-   **`wpbc_fields_before_saving_to_db__general_sync` filter**: This filter is the primary extension point. A developer could hook into it to modify the settings data before it's saved. For example, one could add an additional, hardcoded value to the `booking_gcal_events_form_fields` array.
-   **Form Field Filter**: While not present in this file, it's highly likely that a filter exists for the `wpbc_get__in_all_forms__field_names_arr()` function. A developer could use such a filter to add custom, non-form-based data sources (e.g., a user's display name) to the event mapping dropdowns.
-   **Potential Risks**: The pseudo-option saving mechanism is clever but complex. Any developer extending this page must understand this pattern to correctly read or modify the event mapping settings.

## Next File Recommendations

Now that we understand how the general sync settings are configured, the next logical steps are to see how they are used and to explore other major un-analyzed features.

1.  **`core/sync/wpbc-gcal.php`**: This is a top priority. It will contain the core logic for how the plugin communicates with Google Calendar for both import and export, using the settings configured on this page.
2.  **`core/admin/wpbc-gutenberg.php`**: This remains a key un-analyzed file for understanding how the plugin integrates with the modern WordPress Block Editor, a fundamental aspect of current WordPress development.
3.  **`core/admin/page-timeline.php`**: The booking "Timeline" is a core data visualization feature for administrators. Analyzing this file will reveal how booking data is queried and rendered in a timeline format.