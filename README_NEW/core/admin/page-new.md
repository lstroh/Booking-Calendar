# File Analysis: `core/admin/page-new.php`

This document provides a detailed analysis of the `core/admin/page-new.php` file from the Booking Calendar plugin repository.

## High-Level Overview

This file is responsible for creating and rendering the **Bookings > Add New** page in the WordPress admin panel. Its purpose is to provide a backend interface for administrators to manually create a new booking for any booking resource, essentially filling out the booking form on behalf of a user.

Architecturally, this file defines the page's structure and toolbar. It cleverly reuses the plugin's core front-end rendering engine by firing a custom action hook (`wpdevbk_add_form`) with the appropriate parameters. This delegates the actual rendering of the calendar and booking form, ensuring that the form presented to the admin is consistent with what a front-end user would see.

## Detailed Explanation

The file's logic is contained within the `WPBC_Page_AddNewBooking` class, which extends a parent `WPBC_Page_Structure` class.

-   **`in_page()` and `tabs()` methods**: These methods define the page's identity. `in_page()` returns the unique slug `wpbc-new`, and `tabs()` defines the page's title and main header, "Add New Booking".

-   **`content()` method**: This is the primary method for rendering the page's content. It performs several key actions in sequence:
    1.  **Permission Checks**: It first verifies that the current user has the necessary permissions to be on this page using `wpbc_is_mu_user_can_be_here()` and ensures a default booking resource is selected via `wpbc_set_default_resource_to__get()`.
    2.  **Asset Loading**: It calls `wpbc_js_for_bookings_page()` to enqueue the required JavaScript for the page.
    3.  **Toolbar Rendering**: It calls `wpbc_add_new_booking_toolbar()` to display the toolbar, which typically contains the dropdown menu for selecting the booking resource (calendar) for which to add a booking.
    4.  **Core Content Delegation**: This is the most important architectural aspect. Instead of building the form with raw HTML, the method gathers parameters and then calls `make_bk_action( 'wpdevbk_add_form', ... )`. This fires a custom action hook that is handled elsewhere in the plugin (specifically by the `wpdev_booking` class) to render the complete booking form, including the calendar.
    5.  **Dynamic Options**: The parameters passed to the action are dynamically generated by the `get_saved_user_calendar_options()` method. This allows each admin user to have their own customized view of the calendar on this page (e.g., number of months shown, width).

-   **`get_saved_user_calendar_options()` method**: This helper function retrieves user-specific display settings for the calendar from the `wp_usermeta` table using `get_user_option()`. It then formats these settings into a string of options (e.g., `months_num_in_row=2 width=100%`) that is passed to the form rendering engine.

## Features Enabled

### Admin Menu

-   **"Add New Booking" Page**: This file creates the entire user interface for the `wp-admin/admin.php?page=wpbc-new` page.
-   **Manual Booking Creation**: It provides administrators with a complete booking form, identical to the front-end form, allowing them to select dates, fill in customer details, and create a booking on behalf of a user.
-   **Resource Selection**: Through the toolbar, it allows the admin to switch between different booking resources (calendars) before adding a new booking.

### User-Facing

-   This file has no direct user-facing features but is a core part of the backend management workflow.

## Extension Opportunities

The file provides standard hooks at the top and bottom of the page for adding custom content.

-   **`wpbc_hook_add_booking_page_header`**: An action hook that fires at the top of the page content. This could be used to add custom instructional text, warnings, or additional form elements above the main booking form.
-   **`wpbc_hook_add_booking_page_footer`**: An action hook that fires at the bottom of the page.
-   **Reusing the Form Engine**: Because this page uses the same core form rendering engine as the front-end, any filters that apply to the standard booking form (e.g., for adding fields) would likely also apply here, providing a consistent way to add or alter form fields.

## Next File Recommendations

Now that we understand how a booking is manually created in the admin panel, we can explore other key admin pages or finalize our understanding of core systems like email.

1.  **`includes/page-availability/availability__page.php`**: This is the main file for the "Availability" page. Analyzing it will explain how administrators can create and manage seasonal availability, block out specific dates, and control when their resources can be booked. This is a core feature of any booking system.
2.  **`core/any/api-emails.php`**: We have seen how emails are enhanced and sent. This file likely contains the core API for defining and storing the email templates themselves, which are configured on the **Settings > Emails** page.
3.  **`core/admin/wpbc-gutenberg.php`**: To complete the picture of how the plugin integrates with WordPress, analyzing this file will show how the "Booking Form" block is registered and configured for the modern block editor (Gutenberg).
