# File Analysis: `js/wpbc-gutenberg.js`

## High-Level Overview

This file contains the complete client-side implementation for the plugin's custom Gutenberg block, `booking/booking`. It is written using WordPress's JavaScript framework, which is a wrapper around React. The script's primary purpose is to provide a user-friendly interface within the block editor for adding and configuring various Booking Calendar shortcodes.

Architecturally, this file acts as a bridge between the modern block editor and the plugin's traditional shortcode-based system. Instead of creating a complex, dynamic block that renders a live calendar in the editor, it provides a simple UI that ultimately generates a standard shortcode (e.g., `[booking resource_id=2]`). This shortcode is then saved to the post's content, and the server renders it on the front-end. A key architectural choice is its reuse of the same shortcode configuration modal that is used by the Classic TinyMCE editor, ensuring a consistent user experience.

## Detailed Explanation

The script is composed of two main parts: the block definition and the jQuery event handlers that manage the interaction with the configuration modal.

### Block Definition (`registerBlockType`)

-   **Registration**: The script uses `wp.blocks.registerBlockType('booking/booking', ...)` to register the block with WordPress.
-   **Attribute**: It defines only one attribute: `wpbc_shortcode: { type: 'string', default: '' }`. This is a critical design choice. The entire state and configuration of the block is stored as a single shortcode string.
-   **`edit` function**: This function defines what the content editor sees and interacts with.
    -   It renders a "Configure Booking Calendar Block" button.
    -   It calls a helper function, `wpbc_gt_parse_shortcode()`, which parses the `wpbc_shortcode` attribute and generates a non-interactive, summary-style preview of the configured parameters (e.g., "Booking resource: ID = 2", "Visible months number: 3").
    -   Crucially, it renders a hidden `<input type="text">` field that holds the raw shortcode string. The `onChange` event of this input is what updates the block's attribute via `props.setAttributes()`, which in turn causes the preview to re-render.
-   **`save` function**: This function defines what is saved to the database. It is extremely simple: it returns the raw `wpbc_shortcode` string wrapped in a `<div>`. This means the final post content does not contain complex block markup, but a simple, portable shortcode.

### Modal Integration and Data Flow

-   **Event Handler**: A jQuery `click` handler is attached to the ".wpbc-gutenberg-open-btn" (the "Configure" button).
-   **Reusing the Modal**: When the button is clicked, it calls `wpbc_tiny_btn_click()`. This is the **exact same function** used to open the shortcode generator modal from the Classic TinyMCE editor. This is a clever reuse of existing components.
-   **Passing Context**: Before opening the modal, it stores the block's unique `clientId` in a hidden input field (`#wpbc_text_gettenberg_section_id`) within the modal's DOM. This tells the modal which Gutenberg block instance it should send its output to.
-   **`wpbc_send_text_to_gutenberg(shortcode_text)`**: This function is called by the modal after the user has configured and clicked "Insert".
    1.  It reads the `clientId` from the hidden input.
    2.  It finds the block's specific hidden text field in the editor using the `clientId`.
    3.  It updates the `.val()` of that input field with the new `shortcode_text`.
    4.  It then programmatically triggers a series of jQuery events (`focus`, `click`, `change`) on the input. This is a necessary workaround to force the React-based block editor to recognize that the input has changed, which triggers the `onChange` handler in the `edit` function and saves the new shortcode to the block's attributes.

## Features Enabled

This file is exclusively for the admin panel and provides no user-facing features.

### Admin Menu

-   This file does not add any admin menu pages.
-   It provides the **"Booking Calendar" block** in the Gutenberg editor.
-   It allows users to configure and insert any of the plugin's shortcodes (`[booking]`, `[bookingcalendar]`, `[bookingtimeline]`, etc.) via a user-friendly modal interface.
-   It displays a helpful visual preview of the configured shortcode's parameters directly within the editor, improving the content creation workflow.

## Extension Opportunities

-   **Limited Direct Extension**: The block itself is not designed with internal JavaScript hooks for extension. You cannot easily add a new setting directly to the block's own sidebar, for example.
-   **Extending the Modal**: The primary point of interaction is the shared shortcode modal that is opened by `wpbc_tiny_btn_click()`. The content of this modal is generated by PHP. To add a new option to the Gutenberg block, a developer would need to find the PHP code that builds this modal and see if it contains any action or filter hooks. Any options added to the modal would then be available to both the Gutenberg block and the Classic Editor button.

## Next File Recommendations

The analysis of the Gutenberg integration is now complete. The next logical steps are to investigate the remaining core features of the plugin.

1.  **`includes/page-settings-color-themes/` (Directory)**: This directory likely contains the PHP files responsible for the "Color Themes" or "Skins" settings page. Analyzing its contents will explain how the plugin's visual appearance is managed from the admin side.
2.  **`css/skins/multidays.css`**: To complement the analysis of the color theme settings, examining a specific skin file like this one will reveal how the plugin's theming system applies custom colors and styles for different calendar appearances.
3.  **`js/datepick/jquery.datepick.wpbc.9.0.js`**: This is the core, third-party jQuery Datepick library that has been customized for the plugin. Analyzing it would provide a deep, low-level understanding of how the calendar UI is rendered and how date selection, styling, and user interactions are handled.
